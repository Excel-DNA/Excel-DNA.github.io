<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">9 posts tagged with &quot;Excel&quot; | Excel-DNA</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://excel-dna.github.io/TestDocs/blog/tags/excel"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="9 posts tagged with &quot;Excel&quot; | Excel-DNA"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/TestDocs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://excel-dna.github.io/TestDocs/blog/tags/excel"><link data-rh="true" rel="alternate" href="https://excel-dna.github.io/TestDocs/blog/tags/excel" hreflang="en"><link data-rh="true" rel="alternate" href="https://excel-dna.github.io/TestDocs/blog/tags/excel" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/TestDocs/blog/rss.xml" title="Excel-DNA RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/TestDocs/blog/atom.xml" title="Excel-DNA Atom Feed"><link rel="stylesheet" href="/TestDocs/assets/css/styles.5635b769.css">
<link rel="preload" href="/TestDocs/assets/js/runtime~main.14e2f857.js" as="script">
<link rel="preload" href="/TestDocs/assets/js/main.12b7bfd5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/TestDocs/"><div class="navbar__logo"><img src="/TestDocs/img/logo.svg" alt="Excel-DNA" class="themedImage_ToTc themedImage--light_HNdA"><img src="/TestDocs/img/logo_dark.svg" alt="Excel-DNA" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Excel-DNA</b></a><a class="navbar__item navbar__link" href="/TestDocs/docs/introduction">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/TestDocs/blog">Blog</a><a href="https://groups.google.com/g/exceldna" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" class="header-github-link"></a></div><div class="navbar__item"><a href="https://groups.google.com/g/exceldna" target="_blank" rel="noopener noreferrer" class="header-googlegroup-link"></a></div><div class="navbar__item"><a href="https://www.youtube.com/user/govertvd" target="_blank" rel="noreferrer noopener" class="header-youtube-link"></a></div><div class="navbar__item"><a href="https://github.com/sponsors/Excel-DNA" target="_blank" rel="noopener noreferrer" class="header-sponsor-link"><svg class="sponsor-heart-icon" aria-hidden="true" height="16" viewBox="0 0 16 16" version="1.1" width="16" data-view-component="true"><path fill-rule="evenodd" d="M4.25 2.5c-1.336 0-2.75 1.164-2.75 3 0 2.15 1.58 4.144 3.365 5.682A20.565 20.565 0 008 13.393a20.561 20.561 0 003.135-2.211C12.92 9.644 14.5 7.65 14.5 5.5c0-1.836-1.414-3-2.75-3-1.373 0-2.609.986-3.029 2.456a.75.75 0 01-1.442 0C6.859 3.486 5.623 2.5 4.25 2.5zM8 14.25l-.345.666-.002-.001-.006-.003-.018-.01a7.643 7.643 0 01-.31-.17 22.075 22.075 0 01-3.434-2.414C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.045 5.231-3.885 6.818a22.08 22.08 0 01-3.744 2.584l-.018.01-.006.003h-.002L8 14.25zm0 0l.345.666a.752.752 0 01-.69 0L8 14.25z"></path></svg><span>&nbsp;&nbsp;Sponsor</span></a></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2022/03/07/excel-dna-1.6-.net6-packagereference-anti-virus">Excel-DNA 1.6 – .NET 6 / PackageReference / Anti-virus</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2021/07/15/update-v1.5-sponsors-roadmap">Update v 1.5 / Sponsors / Roadmap</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2020/06/29/excel-dna-version-1.1">Excel-DNA version 1.1</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2019/08/11/getting-started-or-why-are-you-still-using-vba">Getting started (or: Why Are You Still Using VBA?)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2019/03/17/excel-dna-version-1.0">Excel-DNA version 1.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2018/09/21/develop-excel-conference">Develop Excel Conference – London, 18 October 2018</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2017/05/31/excel-dna-0-34-final-testing">Excel-DNA version 0.34</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2016/11/24/excel-udf-intellisense-for-excel-dna-and-vba">Excel UDF IntelliSense for Excel-DNA and VBA</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2016/06/10/add-in-spotlight-acq-for-interpolation">Add-in spotlight: ACQ for interpolation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2015/09/03/excel-dna-version-0-33-8-rc2-available">Excel-DNA version 0.33.8-rc2 available</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2015/08/03/excel-dna-0-33-release-candidate-and-license-change">Excel-DNA 0.33 Release Candidate and License Change</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2014/05/04/excel-dna-0-32-released">Excel-DNA 0.32 Released</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2014/05/03/excel-dna-0-32-breaking-changes-to-integer-and-boolean-parameter-handling">Excel-DNA 0.32 - Breaking changes to integer and boolean parameter handling</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2014/03/21/tutorial-com-server-support-for-vba-integration">Tutorial: COM server support for VBA integration</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2014/03/03/excel-dna-0-32-release-candidate">Excel-DNA 0.32 Release Candidate</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2013/11/14/getting-started-with-f-and-excel-dna-in-finance">Getting started with F# and Excel-DNA in finance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2013/10/07/streaming-real-time-data-to-excel">Streaming real-time data to Excel</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2013/08/05/f-and-r-in-excel">F# and R in Excel</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2013/04/02/caching-and-asynchronous-excel-udfs">Caching and Asynchronous Excel UDFs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2013/03/26/async-and-event-streaming-excel-udfs-with-f">Async and event-streaming Excel UDFs with F#</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2012/12/20/excel-dna-nuget-package-updated">Excel-DNA NuGet Package Updated</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2012/12/13/excel-dna-version-0-30-released">Excel-DNA Version 0.30 Released</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2012/05/04/patrick-obeirnes-guide-on-excel-vba-to-vb-net-migration">Patrick O&#x27;Beirne&#x27;s guide for Excel VBA to VB.NET migration</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2012/01/30/excel-vba-to-vb-net-with-excel-dna-and-netoffice">Excel VBA to VB.NET with Excel-DNA and NetOffice</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2011/05/16/excel-dna-version-0-29-rc-available">Excel-DNA version 0.29 - RC available</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2011/04/28/financial-analytics-suite-finansu-made-with-excel-dna">Financial Analytics Suite (FinAnSu) - made with Excel-DNA</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2011/01/30/resizing-excel-udf-result-arrays">Resizing Excel UDF result arrays</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/TestDocs/blog/2010/12/09/cluster-udf-support">Offloading UDF computations to a Windows HPC cluster from Excel 2010</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>9 posts tagged with &quot;Excel&quot;</h1><a href="/TestDocs/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TestDocs/blog/2022/03/07/excel-dna-1.6-.net6-packagereference-anti-virus">Excel-DNA 1.6 – .NET 6 / PackageReference / Anti-virus</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-03-07T00:36:00.000Z" itemprop="datePublished">March 7, 2022</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/414659" alt="Govert van Drimmelen"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Govert van Drimmelen</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Excel-DNA version 1.6 is now available for testing as pre-release version 1.6.0-preview3 from the NuGet package repository. The extension libraries ExcelDna.Registration and ExcelDna.IntelliSense also have matching releases. ExcelDnaDoc should follow in the coming weeks.</p><p>The main focus for version 1.6 is to provide a first preview of the support for add-ins that target .NET 6. As a prerequisite to adding the .NET 6 target, we’ve also added support for new SDK-style project files and NuGet references (also great for projects that target .NET Framework). I’ve also taken the opportunity to tweak the Excel-DNA packing mechanism a bit in an attempt to avoid some of the false positive anti-virus detections we’ve seen recently. I’ll briefly discuss these (in reverse order) below, but first a word about our sponsors.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="github-sponsors">GitHub sponsors<a class="hash-link" href="#github-sponsors" title="Direct link to heading">​</a></h2><p>Excel-DNA is now registered on GitHub sponsors – see <a href="https://github.com/sponsors/Excel-DNA" target="_blank" rel="noopener noreferrer">https://github.com/sponsors/Excel-DNA</a>. Thank you very much to everyone who has already signed up – your contributions are directly funding further development.</p><p>If you use Excel-DNA and would like to encourage future support and ongoing development, please sign up as a GitHub sponsor for the project. GitHub sponsors will also have access to a private repository of sample projects where I hope to add additional tools and documentation over time.</p><p>I had previously considered the .NET Core / .NET 6 support as a good point to switch to a commercial model for Excel-DNA. However, the benefits of being an open-source project with a permissive license have been significant. So, if possible, I hope to continue with the core library as free and open source software, where further development is funded by the sponsors.</p><p>For those in a corporate setting using Excel-DNA extensively or in a mission critical role, I also offer an annual corporate support agreement. Please contact me directly if you are interested in more details.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="anti-virus-false-positives">Anti-virus false positives<a class="hash-link" href="#anti-virus-false-positives" title="Direct link to heading">​</a></h2><p>Over the last year we’ve seen a number of anti-virus and security programs identify Excel-DNA add-ins as security risks, including false positive detections that delete add-in files by the default Windows Defender service. It seems that these detections were triggered by some malicious Excel add-ins that have been built using Excel-DNA, with the anti-virus heuristics subsequently identifying all Excel-DNA add-ins as problematic. For some security vendors, including Microsoft, we’ve been able to report this false positive detection and they have updated their signatures accordingly. But in many cases the Excel-DNA version 1.5 add-ins are still being flagged.</p><p>It seems the main heuristic used to detect Excel .xll add-ins as problematic is the presence of executable assemblies as resources in the .xll library. Excel-DNA uses the packing of assemblies as resources in the .xll to simplify the add-in distribution, in many cases making possible a single file (or two files for 32-bit and 64-bit) add-in distribution.</p><p>For this version there are two changes which may help with these false positives.</p><p>The first is that packed files are now encoded, so that they are not detected as embedded executable code directly. In my testing that change removed the false positive detections at least in the Microsoft products. However, at least one other user has reported still seeing problems with this version, so it does not seem like bulletproof solution.</p><p>Another option has been contributed by user @Phundamentals (thank you!), to add a project property which disables the compression of packed files.</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">ExcelDnaPackCompressResources</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">false</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">ExcelDnaPackCompressResources</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Should these mitigations not be enough to reduce most false positives, we could also introduce an option where there are no packed files at all (currently the managed Excel-DNA assemblies are always packed).</p><p>There have also been some indications that signing the final add-in library helps reduce false positive detections.</p><p>In all cases I do encourage developers to report the false positives to their anti-virus or security vendor. Their software is mistakenly identifying and blocking legitimate add-ins from running.</p><p>Developers of malicious add-ins are welcome to contact me for sponsored licenses of an alternative add-in framework.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="packagereference-and-sdk-style-project-files">PackageReference and SDK-style project files<a class="hash-link" href="#packagereference-and-sdk-style-project-files" title="Direct link to heading">​</a></h2><p>The main ExcelDna.AddIn NuGet package now supports references in SDK-style project files. For new projects, this means that a .dna file is no longer added to the project automatically, and if not present will be created and output at build time from project properties. Existing projects with customized .dna file(s) will work as they did before.</p><p>For a new project, a simple project file might look like this:</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Project</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">Sdk</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">Microsoft.NET.Sdk</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">PropertyGroup</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">TargetFramework</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">net472</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">TargetFramework</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- We don&#x27;t need the extra &#x27;ref&#x27; directory and reference assemblies for the Excel add-in --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">ProduceReferenceAssembly</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">false</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">ProduceReferenceAssembly</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- We need all dependencies to be copied to the output directory, as-if we are an &#x27;application&#x27; and not a &#x27;library&#x27;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">         This property also sets the CopyLockFileAssemblies property to true. --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">EnableDynamicLoading</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">true</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">EnableDynamicLoading</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">PropertyGroup</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">ItemGroup</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">PackageReference</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">Include</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">ExcelDna.AddIn</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">Version</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">1.6.0-preview3</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">ItemGroup</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">Project</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Various additional properties can be set in the project file – see the example here <a href="https://github.com/Excel-DNA/ExcelDna/blob/master/Source/Tests/ExcelDna.AddIn.Tasks.IntegrationTests.TestTarget/SDKProperties/SDKProperties.csproj" target="_blank" rel="noopener noreferrer">https://github.com/Excel-DNA/ExcelDna/blob/master/Source/Tests/ExcelDna.AddIn.Tasks.IntegrationTests.TestTarget/SDKProperties/SDKProperties.csproj</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="net-6-support">.NET 6 support<a class="hash-link" href="#net-6-support" title="Direct link to heading">​</a></h2><p>Excel-DNA version 1.6 (finally!) includes support for add-ins that target .NET 6. Most Excel-DNA features seem to work, including the COM-based features like RTD-based functions, ribbon and CTP extensions. However, there has been very limited testing and you should consider the .NET 6 support as an early preview.</p><p>Update the TargetFramework tag in an SDK-style project file to the .NET 6 (Windows) target:</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">TargetFramework</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">net6.0-windows</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">TargetFramework</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>or build for both .NET Framework and .NET 6, which allows you to test both targets:</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">TargetFrameworks</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">net472;net6.0-windows</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">TargetFrameworks</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>End users of the add-in will need to have the .NET 6 runtime installed. (To include the runtime files as part of the add-in will not be supported, but an installer program might check and install the runtime.)</p><p>A hard limitation of the .NET core series of runtimes (.NET 5 / 6 / 7 etc.) is that only one version of a .NET core runtime can be loaded into a specific process. The core runtime can still be loaded concurrently with a .NET Framework runtime (e.g. .NET Framework 4.8), although this is not a configuration officially supported by Microsoft. Excel-DNA will try to support add-ins targeting a .NET Framework running together with .NET 6 add-ins, but there is not planned to be any support for the future .NET 7 runtime. Fortunately .NET 6 is a ‘Long-term Support’ (LTS) release and will be formally supported until the end of 2024, so we can keep targeting .NET 6 for a few years. There is also some work on the horizon that make ahead-of-time compilation of .NET libraries (like the Excel-DNA add-ins) viable, bypassing the concurrent runtime issues. So I do expect a future path beyond .NET 6, though that is not an immediate concern.</p><p>I look forward to bug reports, questions and other feedback about the .NET 6 support (including whether it works at all). Support for modern .NET has been a long time coming and ensures that Excel-DNA can take part in the exciting future evolution of .NET.</p><p>After 16 years I am still amazed by and deeply appreciate the support and enthusiasm for Excel-DNA. Last but not least I want to thank Sergey Vlasov for his calm and consistent efforts that are now driving the project forward.</p><p>-Govert</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/net">.NET</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/excel">Excel</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/excel-dna">ExcelDNA</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/xll">XLL</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TestDocs/blog/2021/07/15/update-v1.5-sponsors-roadmap">Update v 1.5 / Sponsors / Roadmap</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-07-15T11:49:00.000Z" itemprop="datePublished">July 15, 2021</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/414659" alt="Govert van Drimmelen"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Govert van Drimmelen</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="excel-dna-version-15">Excel-DNA version 1.5<a class="hash-link" href="#excel-dna-version-15" title="Direct link to heading">​</a></h2><p>A release candidate for the next version of Excel-DNA is now available for testing. Please try out this update, and let me know if you run into any problems or whether you are able to confirm that your add-in still works correctly. I expect to make a final release in a few weeks.</p><p>This update includes a completely new implementation of the core marshaling, replacing code that I initially wrote in 2005. I’ve also done some internal refactoring to prepare for supporting the .NET 5+ generation of runtimes. Finally, a few improvements were made to improve add-in load times when many functions are registered. Improved resilience in hostile anti-virus environments were also implemented since the last release.</p><p>Modernising the marshaling code has resulted in two notable changes of the minimum requirements for using Excel-DNA.</p><ul><li>Only .NET Framework versions 4.5.2 to 4.8 are supported, and</li><li>Excel 2007 or newer is required, dropping support for the oldest versions of Excel.</li></ul><p>UPDATE NOTE:
If you are updating the NuGet package on a project that currently targets an older version of .NET (e.g. .NET Framework 4.0), you should change the target framework for the project to .NET Framework 4.5.2 or later, before updating the NuGet package. Otherwise you may get one of the following problems:</p><ul><li>The package install script may not run when the new package is installed. This leaves the project with a file called “_UNINSTALLED_xxxxx-AddIn.dna”. In this case, uninstall the ExcelDna.AddIn package, update the project target framework, and then reinstall. You might need to restart Visual Studio to complete the package updates.</li><li>Error messages stating “Error CS0246 – The type or namespace name ‘ExcelDna’ could not be found (are you missing a using directive or an assembly reference?)”. This also indicates that the target framework is not supported and should be updated, after which the errors should be resolved.</li></ul><p>Apart from the new minimum requirements, the new release is a highly compatible update and you should not expect any issues or significant behaviour changes after updating.</p><p>Thank you to @ittegrat and @augustoproiete for their contributions to this version.</p><p>The following prerelease packages are available on NuGet:</p><ul><li>ExcelDna.AddIn.1.5.0-rc1</li><li>ExcelDna.Integration.1.5.0-rc1</li><li>ExcelDna.IntelliSense.1.5.0-rc1</li><li>ExcelDna.Registration.1.5.0-rc1</li><li>ExcelDna.Registration.VisualBasic.1.5.0-rc1</li><li>ExcelDna.Registration.FSharp.1.5.0-rc1</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="github-sponsors">GitHub Sponsors<a class="hash-link" href="#github-sponsors" title="Direct link to heading">​</a></h2><p>Excel-DNA is now registered on the <a href="https://github.com/sponsors/Excel-DNA" target="_blank" rel="noopener noreferrer">GitHub sponsors</a> program. This lets you sponsor future Excel-DNA development, and also gives access to direct support for your Excel-DNA projects.
Billing for the monthly sponsorship is through your GitHub account, making it easy to add sponsorship of open-source projects to a corporate GitHub account.</p><p>If you are using Excel-DNA and would like to see further development and ongoing support, please sign up as a sponsor.
A big thank you to those users who were the first to do so: @PierreYvesR, @terryaney, @mhouldsworth @KoosBusters and one private sponsor.</p><p>I’ve set up three levels of monthly sponsorship subscriptions:</p><ul><li>Individual – $14 pm. For power users and developers making add-ins for personal or limited use.</li><li>Team – $170 pm. For smaller development teams in a company, those publishing add-ins externally or using more advanced add-in features.</li><li>Corporate – $850 pm. For larger companies with mission critical applications or multiple development teams.</li></ul><p>For the Team and Corporate sponsorship levels I am also available for some monthly direct support sessions to help deal with problems or advise on your add-in projects.</p><p>The direct corporate support contracts are available as before, with bespoke agreements and extensive direct support.
Thank you very much to the existing corporate partners who have supported Excel-DNA over the past decade and continue to ensure the project’s viability.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="roadmap">Roadmap<a class="hash-link" href="#roadmap" title="Direct link to heading">​</a></h2><p>The development work for Excel-DNA will next address two areas:</p><ul><li>Improved support for SDK-style project files and a PackageReference import of the main NuGet package. The newer .NET project templates and build tools are based on the SDK-style project files, so updating to support these even when targeting .NET Framework will be a big step forward. The main hurdle so far has been the install script and build tasks which depend on the older packages.config style NuGet implementation.</li><li>Support for the .NET 5+ generation of runtimes. I’ve made some progress towards the new add-in hosting code required for loading the .NET 5+ runtime, but getting to an implementation that can be supported for the future and work together with existing add-ins still needs a lot of work. The .NET 5+ runtime versions have more limited isolation capabilities, and different versions cannot be loaded side-by-side in the process. This might require us to standardise on a specific version like the .NET 6 Long Term Support release as the single supported .NET 5+ runtime target.</li></ul><p>Thank you for your ongoing enthusiasm for Excel-DNA and the super-power combination of .NET and Excel. I look forward to your thoughts and feedback.</p><p>-Govert</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/net">.NET</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/excel">Excel</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/excel-dna">ExcelDNA</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TestDocs/blog/2014/03/21/tutorial-com-server-support-for-vba-integration">Tutorial: COM server support for VBA integration</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2014-03-21T23:16:00.000Z" itemprop="datePublished">March 21, 2014</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/414659" alt="Govert van Drimmelen"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Govert van Drimmelen</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Functions and macros created in an Excel-DNA add-in can be called directly from Excel VBA by using <code>Application.Run(...)</code>. However, .NET also supports creating rich object models that are exported as COM libraries, which can be Tools-&gt;Referenced in VBA. Excel-DNA has some advanced support to host COM-exported objects from Excel-DNA add-ins, giving some advantages over the regular .NET &quot;Register for COM interop&quot; hosting approach:</p><ul><li><p>COM objects that are created via the Excel-DNA COM server support will be active in the same AppDomain as the rest of the add-in, allowing direct shared access to static variables, internal caches etc.</p></li><li><p>COM registration for classes hosted by Excel-DNA does not require administrative access (even when registered via <code>RegSvr32.exe</code>).</p></li><li><p>Everything needed for the COM server can be packed in a single-file .xll add-in, including the type library used for IntelliSense support in VBA.</p></li></ul><p><a href="http://mikejuniperhill.blogspot.com/" target="_blank" rel="noopener noreferrer">Mikael Katajamäki</a> has written some detailed tutorial posts on his <a href="http://mikejuniperhill.blogspot.com/" target="_blank" rel="noopener noreferrer">Excel in Finance</a> blog that explore this Excel-DNA feature, with detailed explanation, step-by-step instructions, screen shots and further links. See:</p><ul><li><a href="http://mikejuniperhill.blogspot.com/2014/03/interfacing-c-and-vba-with-exceldna-no.html" target="_blank" rel="noopener noreferrer">Interfacing C# and VBA with Excel-DNA (no intellisense support)</a></li><li><a href="http://mikejuniperhill.blogspot.com/2014/03/interfacing-c-and-vba-with-exceldna_16.html" target="_blank" rel="noopener noreferrer">Interfacing C# and VBA with Excel-DNA (with intellisense support)</a></li></ul><p>Note that these techniques would work equally well with code written in VB.NET, allowing you to port VB/VBA libraries to VB.NET with Excel-DNA and then use these from VBA.</p><p>Thank you Mikael for the great write-up!</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/net">.net</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/com">com</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/excel">excel</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/excel-vba">excel-vba</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/exceldna">exceldna</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/vba">vba</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/xll">xll</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TestDocs/blog/2013/11/14/getting-started-with-f-and-excel-dna-in-finance">Getting started with F# and Excel-DNA in finance</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2013-11-14T00:20:00.000Z" itemprop="datePublished">November 14, 2013</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/414659" alt="Govert van Drimmelen"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Govert van Drimmelen</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="http://bramjochems.com" target="_blank" rel="noopener noreferrer">Bram Jochems</a> has written a friendly <a href="http://bramjochems.com/blog/2013/10/example-f-exceldna/" target="_blank" rel="noopener noreferrer">&quot;Getting Started&quot; post</a>, discussing how to use F# with Excel-DNA in a finance context. His add-in with various F# / Excel-DNA helper utilities, and a bunch of quantitative finance-related UDFs, including option pricing function and volatility interpolation, has been published as a <a href="https://github.com/bramjochems/MyExcelLib" target="_blank" rel="noopener noreferrer">project on GitHub</a>.</p><p>It&#x27;s well worth a look, whether you are using F# and keen to explore Excel-DNA, or just curious about F# and looking for some practical examples.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/examples">examples</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/excel">excel</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/rtd">rtd</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/rx">rx</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TestDocs/blog/2013/10/07/streaming-real-time-data-to-excel">Streaming real-time data to Excel</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2013-10-07T23:13:00.000Z" itemprop="datePublished">October 7, 2013</time> · <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/414659" alt="Govert van Drimmelen"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Govert van Drimmelen</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Gert-Jan van der Kamp has posted a very nice end-to-end example on <a href="http://www.codeproject.com/Articles/662009/Streaming-realtime-data-to-Excel" target="_blank" rel="noopener noreferrer">CodeProject</a>, showing how to create a WCF service and Excel-DNA add-in to stream real-time data into Excel.</p><p>The example uses to use the Reactive Extensions support in Excel-DNA v. 0.30 to push the data to an Excel UDF (using Excel&#x27;s RTD mechanism behind the scenes), together with a Duplex WCF service providing the data.</p><p>There was also this <a href="https://exceldna.codeplex.com/discussions/460904" target="_blank" rel="noopener noreferrer">CodePlex discussion</a> about the Excel ThrottleInterval option, which trades off the real-time update frequency against stability of the Excel calculation.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/examples">examples</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/excel">excel</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/rtd">rtd</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/rx">rx</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TestDocs/blog/2013/04/02/caching-and-asynchronous-excel-udfs">Caching and Asynchronous Excel UDFs</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2013-04-02T23:32:00.000Z" itemprop="datePublished">April 2, 2013</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/414659" alt="Govert van Drimmelen"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Govert van Drimmelen</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This sample shows how the result of an Excel-DNA async UDF call can be cached using the .NET 4 MemoryCache class.</p><p>PS: Apparently there is a bug in the memory management of the .NET MemoryCache class. See the <a href="http://stackoverflow.com/questions/6895956/memorycache-strangeness" target="_blank" rel="noopener noreferrer">StackOverflow discussion</a> and the <a href="https://connect.microsoft.com/VisualStudio/feedback/details/806334/system-runtime-caching-memorycache-do-not-respect-memory-limits#" target="_blank" rel="noopener noreferrer">Connect bug report</a>. The <a href="http://www.nuget.org/packages/SharpMemoryCache" target="_blank" rel="noopener noreferrer">SharpMemoryCache NuGet package</a> might be an alternative, though I&#x27;ve not tried it.</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">DnaLibrary</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">Name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">CachedAsyncSample</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">RuntimeVersion</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">v4.0</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">Language</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">C#</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">Reference</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">Name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">System.Runtime.Caching</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token cdata" style="color:#999988;font-style:italic">&lt;![CDATA[</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    using System;</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    using System.Threading;</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    using System.Runtime.Caching;</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    using ExcelDna.Integration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    public static class dnaFunctions</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">        public static object dnaCachedAsync(string input)</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            // First check the cache, and return immediately </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            // if we found something.</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            // (We also need a unique key to identify the cache item)</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            string key = &quot;dnaCachedAsync:&quot; + input;</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            ObjectCache cache = MemoryCache.Default; </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            string cachedItem = cache[key] as string;</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            if (cachedItem != null) </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">                return cachedItem;</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            // Not in the cache - make the async call </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            // to retrieve the item. (The second parameter here should identify </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            // the function call, so would usually be an array of the input parameters, </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            // but here we have the identifying key already.)</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            object asyncResult = ExcelAsyncUtil.Run(&quot;dnaCachedAsync&quot;, key, () =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">                // Here we fetch the data from far away....</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">                // This code will run on a ThreadPool thread.</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">                // To simulate a slow calculation or web service call,</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">                // Just sleep for a few seconds...</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">                Thread.Sleep(5000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">                // Then return the result</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">                return &quot;The calculation with input &quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">                        + input + &quot; completed at &quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">                        + DateTime.Now.ToString(&quot;HH:mm:ss&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            // Check the asyncResult to see if we&#x27;re still busy</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            if (asyncResult.Equals(ExcelError.ExcelErrorNA))</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">                return &quot;!!! Fetching data&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            // OK, we actually got the result this time.</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            // Add to the cache and return</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            // (keeping the cached entry valid for 1 minute)</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            // Note that the function won&#x27;t recalc automatically after </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            //    the cache expires. For this we need to go the </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            //    RxExcel route with an IObservable.</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            cache.Add(key, asyncResult, DateTime.Now.AddMinutes(1), null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            return asyncResult;</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">        public static string dnaTest()</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">            return &quot;Hello from CachedAsyncSample&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="display:inline-block;color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">  ]]&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">DnaLibrary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/samples">samples</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/async">async</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/csharp">csharp</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/cache">cache</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/excel">excel</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/udf">udf</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TestDocs/blog/2013/03/26/async-and-event-streaming-excel-udfs-with-f">Async and event-streaming Excel UDFs with F#</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2013-03-26T08:18:00.000Z" itemprop="datePublished">March 26, 2013</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/414659" alt="Govert van Drimmelen"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Govert van Drimmelen</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>There have been a some recent posts mentioning the <a href="http://blogs.msdn.com/b/dsyme/archive/2013/03/24/asynchronous-programming-from-f-to-python.aspx" target="_blank" rel="noopener noreferrer">asynchronous</a> and <a href="http://www.infoq.com/interviews/petricek-fsharp-functional-languages" target="_blank" rel="noopener noreferrer">reactive</a> programming features in F#. Since Excel-DNA 0.30 added support for creating async and <code>IObservable</code>-based real-time data functions, I&#x27;d like to show how these F# features can be nicely exposed to Excel via Excel-DNA.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="iobservable-to-excel-via-excel-dna">IObservable to Excel via Excel-DNA<a class="hash-link" href="#iobservable-to-excel-via-excel-dna" title="Direct link to heading">​</a></h2><p>Excel-DNA 0.30 allows an add-in to expose <code>IObservable</code> sources to Excel as real-time data functions. (Actually Excel-DNA defines an interface called <code>IExcelObservable</code> that matches the semantics of `IObservable&lt;\object&gt; - this is because we still target .NET 2.0 with the core library.)</p><p>Asynchronous function can then be implemented as an <code>IObservable</code> that returns a single value before completing. Cancellation (triggered when the user removes a real-time or async formula) is supported via the standard IDisposable mechanism.</p><p>Internally, Excel-DNA implements a thread-safe RTD server and registers the <code>IObservable</code> as an RTD topic. So some aspects of the <code>IObservable</code> support are subject to Excel&#x27;s RTD feature works, for example the RTD throttle interval (by default 2 seconds) will also apply to <code>IObservable</code> functions.</p><p>The following functions in the <code>ExcelDna.Integration.ExcelAsyncUtil</code> helper class are relevant:</p><ul><li><p><code>ExcelAsyncUtil.Initialize()</code> - this should be called in a macro context before any of the other features are used, typically from the <code>AutoOpen()</code> handler.</p></li><li><p><code>ExcelAsyncUtil.Observe(...)</code> - registers an IExcelObservable as a real-time data function with Excel. <code>Subsequent OnNext()</code> calls will raise updates via RTD.</p></li><li><p><code>ExcelAsyncUtil.Run(...)</code> - a helper method that runs a function asynchronously on a .NET threadpool thread.</p></li></ul><p>In addition, we&#x27;ll use</p><ul><li><code>ExcelObservableSource</code> - a delegate type for functions that return an <code>IExcelObservable</code>.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="some-links">Some links:<a class="hash-link" href="#some-links" title="Direct link to heading">​</a></h3><ul><li><a href="http://exceldna.codeplex.com/wikipage?title=Asynchronous%20Functions" target="_blank" rel="noopener noreferrer">Async functions in C#</a> - has some sample functions in C#.</li><li><a href="http://exceldna.codeplex.com/wikipage?title=Reactive%20Extensions%20for%20Excel" target="_blank" rel="noopener noreferrer">Reactive Extensions for Excel (RxExcel)</a> - the RxExcel class is a small wrapper that bridges the <code>IExcelObservable</code> to any implementation of <code>IObservable&lt;T&gt;</code>, allowing the Rx libraries to be used in Excel.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="f-helpers-for-async-and-iobservable-based-events">F# helpers for async and IObservable-based events<a class="hash-link" href="#f-helpers-for-async-and-iobservable-based-events" title="Direct link to heading">​</a></h2><p>To initialize the async support in Excel-DNA, we need some code like the following:</p><div class="language-fsharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fsharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">namespace</span><span class="token plain"> FsAsync</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">open</span><span class="token plain"> System</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">open</span><span class="token plain"> System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Threading</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">open</span><span class="token plain"> System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">open</span><span class="token plain"> Microsoft</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FSharp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Control</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WebExtensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">open</span><span class="token plain"> ExcelDna</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// This class implements the IExcelAddin which allows us to initialize the ExcelAsyncUtil support.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// It must not be a nested class (e.g. defined as a type inside a module) but a top-level class (inside a namespace)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">FsAsyncAddIn</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">IExcelAddIn</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">member</span><span class="token plain"> this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AutoOpen </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ExcelAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Initialize </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">member</span><span class="token plain"> this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AutoClose </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ExcelAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Uninitialize </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// define a regular Excel UDF just to show that the add-in works</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">[&lt;</span><span class="token annotation class-name">ExcelFunction</span><span class="token annotation annotation-content punctuation" style="color:#393A34">(</span><span class="token annotation annotation-content">Description</span><span class="token annotation annotation-content operator" style="color:#393A34">=</span><span class="token annotation annotation-content string" style="color:#e3116c">&quot;A test function from F#&quot;</span><span class="token annotation annotation-content punctuation" style="color:#393A34">)</span><span class="token annotation punctuation" style="color:#393A34">&gt;]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">member</span><span class="token plain"> fsaAddThem </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token class-name">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token class-name">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> y</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>F# supports an asynchronous programming model via &quot;async computation expressions&quot;. The result of an async computation expression is a value of type <code>Async&lt;T&gt;</code>, which we need to convert to an <code>IExcelObservable</code>. We use a standard <code>CancellationTokenSource</code> hooked up to the <code>IDisposable</code> to enable cancellation.</p><div class="language-fsharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fsharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">module</span><span class="token plain"> FsAsyncUtil </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// A helper to pass an F# Async computation to Excel-DNA </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> excelRunAsync functionName parameters async </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> obsSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">ExcelObservableSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IExcelObservable</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">member</span><span class="token plain"> __</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Subscribe observer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">// make something like CancellationDisposable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> cts </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">CancellationTokenSource</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> disp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IDisposable</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">member</span><span class="token plain"> __</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dispose </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Cancel </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">// Start the async computation on this thread</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Async</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StartWithContinuations </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">   async</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    observer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OnNext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    observer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OnCompleted </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> ex </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> observer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OnError ex </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> ex </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    observer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OnCompleted </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                cts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Token </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">// return the disposable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        disp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExcelAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Observe </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">functionName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parameters</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> obsSource</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Another neat feature of F# is that events are first-class types that implement <code>IObservable</code>. This means any F# event can serve as a real-time data source in an Excel formula. To bridge the F# events to the <code>IExcelObservable</code> interface is really easy, we just have the following helper:</p><div class="language-fsharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fsharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/// A helper to pass an F# IObservable to Excel-DNA</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> excelObserve functionName parameters observable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> obsSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">ExcelObservableSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IExcelObservable</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">member</span><span class="token plain"> __</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Subscribe observer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// Subscribe to the F# observable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Observable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subscribe </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> observer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OnNext </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> observable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ExcelAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Observe </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">functionName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parameters</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> obsSource</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sample-functions">Sample functions<a class="hash-link" href="#sample-functions" title="Direct link to heading">​</a></h2><p>Given the above helpers, we can now explore a few ways to implement async and real-time streaming functions. As examples:</p><p>Here is a plain synchronous function to download a url into a string:</p><div class="language-fsharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fsharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> downloadString url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> uri </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">System</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Uri</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> webClient </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">WebClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> html </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> webClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">DownloadString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ex </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;!!!ERROR: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> ex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Message</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>Async implementation 1</strong>: Use Excel-DNA async directly to run <code>downloadString</code> on a <code>ThreadPool</code> thread</li></ul><div class="language-fsharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fsharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> downloadStringAsyncRunTP1 url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ExcelAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;downloadStringAsyncTP1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> downloadString url </span><span class="token operator" style="color:#393A34">:&gt;</span><span class="token plain"> </span><span class="token class-name">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Create an F# asynchronous computation for the download (this functions is not exported to Excel)</p><div class="language-fsharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fsharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> downloadStringAsyncImpl url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token computation-expression keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// In here we could check for cancellation using </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// let! ct = Async.CancellationToken</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// if ct.IsCancellationRequested then ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> uri </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">System</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Uri</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> webClient </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">WebClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let!</span><span class="token plain"> html </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> webClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AsyncDownloadString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ex </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;!!!ERROR: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> ex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Message </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>Async implementation 2</strong>: This function runs the async computation synchronously on a <code>ThreadPool</code> thread because that&#x27;s what <code>ExcelAsyncUtil.Run</code> does. Blocking calls will block a <code>ThreadPool</code> thread, eventually limiting the concurrency of the async calls</li></ul><div class="language-fsharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fsharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> downloadStringAsyncTP2 url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ExcelAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;downloadStringAsyncTP2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Async</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RunSynchronously </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">downloadStringAsyncImpl url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:&gt;</span><span class="token plain"> </span><span class="token class-name">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>Async implementation 3</strong>: Use the helper we defined above. This runs the async computation using true F# async. Should not block <code>ThreadPool</code> threads, and allows cancellation</li></ul><div class="language-fsharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fsharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> downloadStringAsync url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FsAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">excelRunAsync </span><span class="token string" style="color:#e3116c">&quot;downloadStringAsync&quot;</span><span class="token plain"> url </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">downloadStringAsyncImpl url</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Helper that will create a timer that ticks at <code>timerInterval</code> for <code>timerDuration</code>, and is then done. Also not exported to Excel (incompatible signature). Notice that from F#, the <code>timer.Elapsed</code> event of the BCL <code>Timer</code> class implements <code>IObservable</code>, so can be used directly with the transformations in the F# <code>Observable</code> module.</p><div class="language-fsharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fsharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> createTimer timerInterval timerDuration </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// setup a timer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> timer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">System</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Timers</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Timer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">float timerInterval</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AutoReset </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// return an async task for stopping it after the duration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> timerStop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token computation-expression keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        timer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">do</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> Async</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Sleep timerDuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        timer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Stop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Async</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Start timerStop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Make sure that the type we actually observe in the event is supported by Excel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// by converting the events to timestamps</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Elapsed </span><span class="token operator" style="color:#393A34">|&gt;</span><span class="token plain"> Observable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> elapsed </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> DateTime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Now</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>Event implementation</strong>: Finally this is the Excel function that will tick away in a cell. Entered into a cell (<em>and formatted as a Time value</em>), the formula <code>=startTimer(5000, 60000)</code> will show a clock that ticks every 5 seconds for a minute.</li></ul><div class="language-fsharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fsharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> startTimer timerInterval timerDuration </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FsAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">excelObserve </span><span class="token string" style="color:#e3116c">&quot;startTimer&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">float timerInterval</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> float timerDuration</span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">createTimer timerInterval timerDuration</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="putting-everything-together-in-an-excel-add-in">Putting everything together in an Excel add-in<a class="hash-link" href="#putting-everything-together-in-an-excel-add-in" title="Direct link to heading">​</a></h2><p>A complete <code>.dna</code> script file with the above code can be found in the <a href="https://github.com/Excel-DNA/ExcelDna" target="_blank" rel="noopener noreferrer">Excel-DNA distribution</a>, under <a href="https://github.com/Excel-DNA/ExcelDna/blob/master/Distribution/Samples/Async/FsAsync.dna" target="_blank" rel="noopener noreferrer">Distribution\Samples\Async\FsAsync.dna</a>.</p><p>Alternatively, the following steps would build an add-in in Visual Studio:</p><ul><li>Create a new F# library in Visual Studio.</li><li>Install the Excel-DNA package from NuGet (<code>Install-Package Excel-DNA</code> from the NuGet console).</li><li>Set up the Debug path:<ol><li>Select “Start External Program” and browse to find Excel.exe, e.g. for Excel 2010 the path might be: <code>C:\Program Files (x86)\Microsoft Office\Office14\EXCEL.EXE</code>.</li><li>Enter the full path to the <code>.xll</code> file in the output as the Command line arguments, e.g. <code>C:\MyProjects\TestDnaFs\bin\Debug\TestDnaFs-addin.xll</code>.</li></ol></li><li>Place the following code in <code>Library1.fs</code>, compile and run:</li></ul><div class="language-fsharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fsharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">namespace</span><span class="token plain"> FsAsync</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">open</span><span class="token plain"> System</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">open</span><span class="token plain"> System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Threading</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">open</span><span class="token plain"> System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">open</span><span class="token plain"> Microsoft</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FSharp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Control</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WebExtensions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">open</span><span class="token plain"> ExcelDna</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Integration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// This class implements the IExcelAddin which allows us to initialize the ExcelAsyncUtil support.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// It must not be a nested class (e.g. defined as a type inside a module) but a top-level class (inside a namespace)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token class-name">FsAsyncAddIn</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">IExcelAddIn</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">member</span><span class="token plain"> this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AutoOpen </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ExcelAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Initialize </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">member</span><span class="token plain"> this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AutoClose </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ExcelAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Uninitialize </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// a regular Excel UDF just to show that the add-in works</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">member</span><span class="token plain"> fsaAddThem </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token class-name">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token class-name">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// Some utility functions for connecting Excel-DNA async with F#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">module</span><span class="token plain"> FsAsyncUtil </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// A helper to pass an F# Async computation to Excel-DNA </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> excelRunAsync functionName parameters async </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> obsSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">ExcelObservableSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IExcelObservable</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">member</span><span class="token plain"> __</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Subscribe observer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">// make something like CancellationDisposable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> cts </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">CancellationTokenSource</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> disp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IDisposable</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">member</span><span class="token plain"> __</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dispose </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Cancel </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">// Start the async computation on this thread</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Async</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StartWithContinuations </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">   async</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    observer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OnNext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    observer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OnCompleted </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> ex </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> observer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OnError ex </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> ex </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    observer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OnCompleted </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                cts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Token </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">// return the disposable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        disp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExcelAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Observe </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">functionName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parameters</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> obsSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// A helper to pass an F# IObservable to Excel-DNA</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> excelObserve functionName parameters observable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> obsSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">ExcelObservableSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">IExcelObservable</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">member</span><span class="token plain"> __</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Subscribe observer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token comment" style="color:#999988;font-style:italic">// Subscribe to the F# observable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Observable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subscribe </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> observer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OnNext </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> observable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExcelAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Observe </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">functionName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parameters</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> obsSource</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Some test functions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">module</span><span class="token plain"> TestFunctions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Plain synchronous download function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// can be called from Excel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> downloadString url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> uri </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">System</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Uri</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> webClient </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">WebClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> html </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> webClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">DownloadString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ex </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;!!!ERROR: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> ex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Uses Excel-DNA async to run download on a ThreadPool thread</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> downloadStringAsyncTP1 url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExcelAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;downloadStringAsyncTP1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> downloadString url </span><span class="token operator" style="color:#393A34">:&gt;</span><span class="token plain"> </span><span class="token class-name">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Create an F# asynchronous computation for the download</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Not exported to Excel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> downloadStringAsyncImpl url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token computation-expression keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// In here we could check for cancellation using </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// let! ct = Async.CancellationToken</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// if ct.IsCancellationRequested then ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> uri </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">System</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Uri</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> webClient </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">WebClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let!</span><span class="token plain"> html </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> webClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AsyncDownloadString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> ex </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;!!!ERROR: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> ex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Message </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// This function runs the async computation synchronously on a ThreadPool thread</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// because that&#x27;s what ExcelAsyncUtil.Run does</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Blocking calls will block a ThreadPool thread, eventually limiting the concurrency of the async calls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> downloadStringAsyncTP2 url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ExcelAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Run </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;downloadStringAsyncTP2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Async</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RunSynchronously </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">downloadStringAsyncImpl url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:&gt;</span><span class="token plain"> </span><span class="token class-name">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// This runs the async computation using true F# async</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// Should not block ThreadPool threads, and allows cancellation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> downloadStringAsync url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FsAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">excelRunAsync </span><span class="token string" style="color:#e3116c">&quot;downloadStringAsync&quot;</span><span class="token plain"> url </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">downloadStringAsyncImpl url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Helper that will create a timer that ticks at timerInterval for timerDuration, then stops</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Not exported to Excel (incompatible type)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> createTimer timerInterval timerDuration </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// setup a timer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> timer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">System</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Timers</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Timer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">float timerInterval</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        timer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AutoReset  Observable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> elapsed </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> DateTime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Now</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Excel function to start the timer - using the fact that F# events implement IObservable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> startTimer timerInterval timerDuration </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FsAsyncUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">excelObserve </span><span class="token string" style="color:#e3116c">&quot;startTimer&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">float timerInterval</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> float timerDuration</span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">createTimer timerInterval timerDuration</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="support-and-feedback">Support and feedback<a class="hash-link" href="#support-and-feedback" title="Direct link to heading">​</a></h2><p>The best place to ask any questions related to Excel-DNA is the <a href="http://groups.google.com/group/exceldna" target="_blank" rel="noopener noreferrer">Excel-DNA Google group</a>. Any feedback from F# users trying out Excel-DNA or the features discussed here will be very welcome. I can also be contacted directly at <a href="mailto:govert@dnakode.com" target="_blank" rel="noopener noreferrer">govert@dnakode.com</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/features">features</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/samples">samples</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/async">async</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/excel">excel</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/exceldna">exceldna</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/fsharp">fsharp</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TestDocs/blog/2011/01/30/resizing-excel-udf-result-arrays">Resizing Excel UDF result arrays</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2011-01-30T18:27:00.000Z" itemprop="datePublished">January 30, 2011</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/414659" alt="Govert van Drimmelen"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Govert van Drimmelen</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><strong>Update (21 June 2017): The most up-to-date version of the ArrayResizer utility can be found here</strong>: <a href="https://github.com/Excel-DNA/ExcelDna/blob/master/Distribution/Samples/ArrayResizer.dna" target="_blank" rel="noopener noreferrer">https://github.com/Excel-DNA/ExcelDna/blob/master/Distribution/Samples/ArrayResizer.dna</a></p><p><strong>Update: To work correctly under Excel 2000/2002/2003, this sample requires at least version 0.29.0.12 of Excel-DNA</strong>.</p><p>A common question on the <a href="http://groups.google.com/group/exceldna" target="_blank" rel="noopener noreferrer">Excel-DNA group</a> is how to automatically resize the results of an array formula. The most well-know appearance of this trick is in the Bloomberg add-in.</p><p><strong>WARNING! This is a bad idea</strong>. Excel does not allow you to modify the sheet from within a user-defined function. Doing this breaks Excel&#x27;s calculation model.</p><p>Anyway, here is my attempt at an Excel-DNA add-in that implements this trick. My approach is to run a macro on a separate thread that will check and if required will expand the formula to an array formula of the right size. This way nothing ugly gets done if the array size is already correct - future recalculations will not run the formula array resizer if the size is still correct.</p><p>The code below will register a function call <code>Resize</code>. You can either call <code>Resize</code> from within your function, or enter something like <code>=Resize(MyFunction(…))</code> as the cell formula. The code also registers two sample functions, <code>MakeArray</code> and <code>MakeArrayAndResize</code> to play with, each take the number of rows and columns for the size of the returned array.</p><p>To test this:</p><ol><li><a href="/TestDocs/">Get started with Excel-DNA</a>.</li><li>Copy the code and xml wrapper into a text file called <code>Resizer.dna</code> (the xml wrapper is at the end of this post).</li><li>Copy the <code>ExcelDna.xll</code> in the Excel-DNA distribution to <code>Resizer.xll</code> (next to the <code>Resizer.dna</code>).</li><li>File-&gt;Open the <code>Resizer.xll</code> in Excel and enter something like <code>=MakeArrayAndResize(5,3)</code> into a cell.
See how it grows.</li></ol><p>In the current version, the formula expansion is destructive, so anything in the way will be erased. One case I don&#x27;t know how to deal with is when there is an array that would be partially overwritten by the expended function result. In the current version Excel will display an error that says &quot;You cannot change part of an array.&quot;, and I replace the formula with a text version of it. I&#x27;d love to know how you think we should handle this case.</p><p>Any questions or comments (can if anyone can get it to work, or not?) can be directed to the <!-- -->[Excel-DNA Google group][excel-dna-group]<!-- --> or to me directly via e-mail. I&#x27;m pretty sure there are a few cases where it will break - please let me know if you run into any problems.</p><p>I&#x27;ll try to gather the comments and suggestions for an improved implementation that might go into the next version of Excel-DNA.</p><p>Also, if you have any questions about how the implementation works, I&#x27;d be happy to write a follow up post that explains a bit more of what I&#x27;m doing. But first, let&#x27;s try to get it working.</p><p>Here&#x27;s the Resizer add-in code:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Collections</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Generic</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Reflection</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Runtime</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">InteropServices</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">System</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Threading</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">ExcelDna</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">Integration</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ResizeTest</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">MakeArray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> columns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name keyword" style="color:#00009f">object</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">,</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:#00009f">string</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">rows</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> columns</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> columns</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> j</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">j</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;({0},{1})&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> j</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">MakeArrayAndResize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> columns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name keyword" style="color:#00009f">object</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">MakeArray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rows</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> columns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Call Resize via Excel - so if the Resize add-in is not part of this code, it should still work.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlUDF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Resize&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Resizer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">Queue</span><span class="token class-name punctuation" style="color:#393A34">&lt;</span><span class="token class-name">ExcelReference</span><span class="token class-name punctuation" style="color:#393A34">&gt;</span><span class="token plain"> ResizeJobs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">Queue</span><span class="token constructor-invocation class-name punctuation" style="color:#393A34">&lt;</span><span class="token constructor-invocation class-name">ExcelReference</span><span class="token constructor-invocation class-name punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// This function will run in the UDF context.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Needs extra protection to allow multithreaded use.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">object</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Resize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">object</span><span class="token class-name punctuation" style="color:#393A34">[</span><span class="token class-name punctuation" style="color:#393A34">,</span><span class="token class-name punctuation" style="color:#393A34">]</span><span class="token plain"> array</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ExcelReference</span><span class="token plain"> caller </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlfCaller</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">ExcelReference</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">caller </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> rows </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLength</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> columns </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLength</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">caller</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RowLast </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> caller</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RowFirst </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">caller</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ColumnLast </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> caller</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ColumnFirst </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> columns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Size problem: enqueue job, call async update and return #N/A</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// TODO: Add guard for ever-changing result?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">EnqueueResize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">caller</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> columns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">AsyncRunMacro</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;DoResizing&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ExcelError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ExcelErrorNA</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Size is already OK - just return result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">EnqueueResize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ExcelReference</span><span class="token plain"> caller</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> columns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ExcelReference</span><span class="token plain"> target </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">ExcelReference</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">caller</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RowFirst</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> caller</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RowFirst </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> rows </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> caller</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ColumnFirst</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> caller</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ColumnFirst </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> columns </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> caller</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SheetId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ResizeJobs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Enqueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">DoResizing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ResizeJobs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Count </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">DoResize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ResizeJobs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">DoResize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ExcelReference</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Get the current state for reset later</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlcEcho</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Get the formula in the first cell of the target</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> formula </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlfGetCell</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">41</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ExcelReference</span><span class="token plain"> firstCell </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">ExcelReference</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RowFirst</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RowFirst</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ColumnFirst</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ColumnFirst</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SheetId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">bool</span><span class="token plain"> isFormulaArray </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlfGetCell</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">49</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isFormulaArray</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name keyword" style="color:#00009f">object</span><span class="token plain"> oldSelectionOnActiveSheet </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlfSelection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name keyword" style="color:#00009f">object</span><span class="token plain"> oldActiveCell </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlfActiveCell</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// Remember old selection and select the first cell of the target</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> firstCellSheet </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlSheetNm</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> firstCell</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlcWorkbookSelect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:#00009f">object</span><span class="token constructor-invocation class-name punctuation" style="color:#393A34">[</span><span class="token constructor-invocation class-name punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">firstCellSheet</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name keyword" style="color:#00009f">object</span><span class="token plain"> oldSelectionOnArraySheet </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlfSelection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlcFormulaGoto</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> firstCell</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// Extend the selection to the whole array and clear</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlcSelectSpecial</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">ExcelReference</span><span class="token plain"> oldArray </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ExcelReference</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlfSelection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                oldArray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ExcelEmpty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlcSelect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldSelectionOnArraySheet</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlcFormulaGoto</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldSelectionOnActiveSheet</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Get the formula and convert to R1C1 mode</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">bool</span><span class="token plain"> isR1C1Mode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlfGetWorkspace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> formulaR1C1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> formula</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">isR1C1Mode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// Set the formula into the whole target</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                formulaR1C1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlfFormulaConvert</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> formula</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ExcelMissing</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> firstCell</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Must be R1C1-style references</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">object</span><span class="token plain"> ignoredResult</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">XlCall</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">XlReturn</span><span class="token plain"> retval </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TryExcel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlcFormulaArray</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">out</span><span class="token plain"> ignoredResult</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> formulaR1C1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">retval </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">XlReturn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">XlReturnSuccess</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// TODO: Consider what to do now!?</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// Might have failed due to array in the way.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                firstCell</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;&#x27;&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> formula</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">finally</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Excel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">XlCall</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlcEcho</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Most of this from the newsgroup: http://groups.google.com/group/exceldna/browse_thread/thread/a72c9b9f49523fc9/4577cd6840c7f195</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">readonly</span><span class="token plain"> </span><span class="token class-name">TimeSpan</span><span class="token plain"> BackoffTime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TimeSpan</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FromSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">AsyncRunMacro</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> macroName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Do this on a new thread....</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Thread</span><span class="token plain"> newThread </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name">Thread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">delegate</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">while</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token function" style="color:#d73a49">RunMacro</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">macroName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">catch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">COMException</span><span class="token plain"> cex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">IsRetry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BackoffTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">continue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// TODO: Handle unexpected error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">catch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Exception</span><span class="token plain"> ex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// TODO: Handle unexpected error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        newThread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RunMacro</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">string</span><span class="token plain"> macroName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name keyword" style="color:#00009f">object</span><span class="token plain"> xlApp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name keyword" style="color:#00009f">object</span><span class="token plain"> xlApp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ExcelDnaUtil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Application</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            xlApp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InvokeMember</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Run&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BindingFlags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InvokeMethod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xlApp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name keyword" style="color:#00009f">object</span><span class="token constructor-invocation class-name punctuation" style="color:#393A34">[</span><span class="token constructor-invocation class-name punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">macroName</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TargetInvocationException</span><span class="token plain"> tie</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">throw</span><span class="token plain"> tie</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InnerException</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">finally</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Marshal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ReleaseComObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xlApp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">uint</span><span class="token plain"> RPC_E_SERVERCALL_RETRYLATER </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x8001010A</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">uint</span><span class="token plain"> VBA_E_IGNORE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x800AC472</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">IsRetry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">COMException</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name keyword" style="color:#00009f">uint</span><span class="token plain"> errorCode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ErrorCode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">switch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">errorCode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> RPC_E_SERVERCALL_RETRYLATER</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> VBA_E_IGNORE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can easily make a test add-in for this by wrapping the code into a .dna file with this around:</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">DnaLibrary</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">Language</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">CS</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token cdata" style="color:#999988;font-style:italic">&lt;![CDATA[</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="display:inline-block;color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">    &lt;!--// Paste all of the above code here //--&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="display:inline-block;color:#999988;font-style:italic"></span><br></span><span class="token-line" style="color:#393A34"><span class="token cdata" style="color:#999988;font-style:italic">]]&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">DnaLibrary</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/samples">samples</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/net">.net</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/async">async</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/excel">excel</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/exceldna">exceldna</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/xll">xll</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/TestDocs/blog/2010/12/09/cluster-udf-support">Offloading UDF computations to a Windows HPC cluster from Excel 2010</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2010-12-09T21:02:00.000Z" itemprop="datePublished">December 9, 2010</time> · <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/414659" alt="Govert van Drimmelen"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/Excel-DNA" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Govert van Drimmelen</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Excel 2010 introduced support for offloading UDF computations to a compute cluster. The Excel blog talks about it <a href="http://blogs.msdn.com/b/excel/archive/2010/02/12/offloading-udf-s-to-a-windows-hpc-cluster.aspx" target="_blank" rel="noopener noreferrer">http://blogs.msdn.com/b/excel/archive/2010/02/12/offloading-udf-s-to-a-windows-hpc-cluster.aspx</a>, and there are some nice pictures on this TechNet article: <a href="http://technet.microsoft.com/en-us/library/ff877825(WS.10).aspx" target="_blank" rel="noopener noreferrer">http://technet.microsoft.com/en-us/library/ff877825(WS.10).aspx</a>.</p><p>Excel-DNA now supports marking functions as cluster-safe, and I have updated the loader to allow add-ins to work under the <code>XllContainer</code> on the HPC nodes. There are some issues to be aware of:</p><ul><li>The add-in does not create its own <code>AppDomain</code> when running on the compute node. One consequence is that no custom <code>.xll.config</code> file is used; configuration entries need to be set in the <code>XllContainer</code> configuration setup.</li><li>There are some limitations on the size of array data that can be passed to and from UDF calls - this limit is probably configurable in the WCF service.</li><li>Only the 32-bit host is currently supported.</li></ul><p>To test this you will need an Windows HPC Server 2008 R2 cluster with the HPC Services for Excel installed. On the clients you need Excel 2010 with the HPC cluster connector installed. The latest check-in for Excel-DNA with this support is on GitHub: <a href="https://github.com/Excel-DNA/ExcelDna" target="_blank" rel="noopener noreferrer">https://github.com/Excel-DNA/ExcelDna</a>.</p><p>In the Microsoft HPC SDK there is a sample called ClusterUDF.xll with a few test functions. I have recreated these in C# in the samples file <a href="https://github.com/Excel-DNA/ExcelDna/blob/master/Distribution/Samples/ClusterSample.dna" target="_blank" rel="noopener noreferrer">Distribution\Samples\ClusterSample.dna</a> Basically functions just need to be marked as <code>IsClusterSafe=true</code> to be pushed to the cluster for computation. For example</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token attribute class-name">ExcelFunction</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">(</span><span class="token attribute attribute-arguments">IsClusterSafe</span><span class="token attribute attribute-arguments operator" style="color:#393A34">=</span><span class="token attribute attribute-arguments boolean" style="color:#36acaa">true</span><span class="token attribute attribute-arguments punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">DnaCountPrimesC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> nFrom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#00009f">int</span><span class="token plain"> nTo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As usual, any feedback on this feature - questions or reports on whether you use it - will be most appreciated.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/features">features</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/net">.net</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/excel">excel</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/exceldna">exceldna</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/hpc">hpc</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/TestDocs/blog/tags/xll">xll</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/TestDocs/getting-started/installation">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/TestDocs/guides-basic/tempbasicguide">Guides - Basic</a></li><li class="footer__item"><a class="footer__link-item" href="/TestDocs/guides-advanced/tempadvancedguide">Guides - Advanced</a></li><li class="footer__item">
                  <a href="https://www.youtube.com/user/govertvd" target="_blank" rel="noreferrer noopener" class="footer__link-item"> 
                  <img src="/TestDocs/img/youtube.png" alt="YouTube" width="20.42" height="14.4" style="margin-right:5px;">govertvd
                  </a>
              </li></ul></div><div class="col footer__col"><div class="footer__title">Discussions</div><ul class="footer__items clean-list"><li class="footer__item">
                    <a href="https://groups.google.com/g/exceldna" target="_blank" rel="noreferrer noopener" class="footer__link-item"> 
                    <img src="/TestDocs/img/google_groups.png" alt="Google Groups" width="16" height="16" style="margin-right:5px;">exceldna
                    </a>
                </li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/TestDocs/blog">Blog</a></li><li class="footer__item">
                    <a href="https://github.com/Excel-DNA" target="_blank" rel="noreferrer noopener" class="footer__link-item"> 
                    <img src="/TestDocs/img/github.png" alt="GitHub" width="16" height="16" style="margin-right:5px;">excel-dna
                    </a>
                </li><li class="footer__item">
                    <a href="mailto:govert@dnakode.com" target="_blank" rel="noreferrer noopener" class="footer__link-item"> 
                    <img src="/TestDocs/img/email.png" alt="GitHub" width="16" height="11" style="margin-right:5px;">govert@dnakode.com
                    </a>
                </li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 DNA Kode, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/TestDocs/assets/js/runtime~main.14e2f857.js"></script>
<script src="/TestDocs/assets/js/main.12b7bfd5.js"></script>
</body>
</html>